这节我们来修复一个问题：

![2025-07-07 21.07.34.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/973d45b216cb4dd686e15210ce4fe050~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2812&h=1398&s=583551&e=gif&f=37&b=a9d4e3)

点击切换户型后没反应，刷新之后才会生效。

这很明显，是我们加上的这段代码导致的：


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43da3e8a55fc4d4dbbbe528b1f7ca9e7~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1284&h=1038&s=178468&e=png&b=1f1f1f)

只有 walls 为空数组的时候才会销毁绘制的房子。

但切换户型的时候，我们是直接换了另一个户型数据：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68d1c66850f44a30b594956b99cc3323~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1380&h=1112&s=191742&e=png&b=1f1f1f)

根本没有清空。

所以要加一下清空逻辑：



![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05f6f077b5f54440bfb657a4ed8d543f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1222&h=884&s=128155&e=png&b=1f1f1f)


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b43bc02cb5b4701be4af836a7300669~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1242&h=802&s=114519&e=png&b=1f1f1f)
```javascript
onConfirm={() => {
    setData({
        walls: [],
        floors: [],
        ceilings: [],
        furnitures: []
    });
    setTimeout(() => {
        setData(data1);
    }, 0);
}}
```
```javascript
onConfirm={() => {
    setData({
        walls: [],
        floors: [],
        ceilings: [],
        furnitures: []
    });

    setTimeout(() => {
        setData(data2);
    }, 0 );
}}
```
改成点击切换户型的时候，先清空，然后一秒之后设置新的数据。

当墙的数组为空的时候，也不渲染：


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/339008a92c5449febed2f156dc953e64~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1260&h=844&s=155381&e=png&b=1f1f1f)


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df3f46ba8db04867b33e172d410389ae~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1336&h=866&s=156353&e=png&b=1f1f1f)

```javascript
if(!data.walls.length) {
    return;
}
```
2D、3D 的都要改下。

试下效果：


![2025-07-08 01.00.53.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4dcbab6ebbea40118179f9aa3796734f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2812&h=1398&s=871222&e=gif&f=32&b=a9d1e2)

户型可以切换了，但现在墙可见性的计算不对了：


![2025-07-08 01.01.51.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/000e11be8613428caf179e65a2bda40f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2812&h=1398&s=9081803&e=gif&f=31&b=f3f9fc)

这是为什么呢？

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ff2be5aa59f439e8cdad2772c111d80~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1560&h=1144&s=224002&e=png&b=1f1f1f)


因为这个函数引用的 data 是第一次的，形成了闭包，所以后面切换了户型用的也是之前的 data。

解决方式就是让 data 变成动态获取的。


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/830c5515fdb246ff83cc5755163a0076~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1256&h=834&s=164855&e=png&b=1f1f1f)

```javascript
const dataRef = useRef<State['data']>(null);
dataRef.current = data;
```
```javascript
dataRef.current!.walls.forEach((item, index) => {
```
我们加了一个 ref 来保存每次渲染的 data。

计算墙可见性的时候动态从 ref 里取最新的 data。

这样切换户型之后墙的可见性的计算依然是对的：

![2025-07-08 01.07.28.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb6794d103cc41858200f1e1e17f3cce~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2812&h=1398&s=11928641&e=gif&f=50&b=f5f5f5)

这样切换户型的问题就解决了。

然后我们来改下右边这部分的样式：


![2025-07-08 01.09.01.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2dd6234f31d34c8aa6b28c88b34f934b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2812&h=1398&s=1201926&e=gif&f=24&b=f4f4f4)

它会挡住小视图。

在酷家乐里是这样做的：

![2025-07-08 01.10.23.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f772f579d8941758136bef2a95be2e9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2812&h=1398&s=1180810&e=gif&f=23&b=eef1f2)

会把小视图的空间留出来。

我们也这样改下：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fab77e896de14f64b62c33edd3f8e0e1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1094&h=886&s=128831&e=png&b=1f1f1f)

```css
.Properties {
  height: calc(100vh - 60px - 200px);
  top: auto;
  width: 240px;
  bottom: 0;
}
```
高度在之前的基础上减去小视图的高度。

设置绝对定位在底部。

宽度改为小视图宽度。

这里也要改下：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77a7db6f53774e9f80f735097211af32~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1194&h=684&s=107335&e=png&b=1f1f1f)


![2025-07-08 01.14.44.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/08379961a0c44d7ab01d33be76164cee~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2812&h=1514&s=1424735&e=gif&f=44&b=abd4e3)

这样，右边的面板就不会挡住小视图了。

>案例代码上传了[小册仓库](https://github.com/QuarkGluonPlasma/threejs-course-code/tree/main/home-decoration-editor)

## 总结

这节我们修复了两个问题。

一个是户型切换不生效，我们首先把数据清空，然后再设置新数据就好了。还有墙可见性计算的函数里用的 data 要换成动态获取的，我们用 ref 的方式来获取。

另一个是右边面板会挡住小视图，我们调整了下位置和高度。

bug 修完了，下节我们继续来做家具列表的功能。

