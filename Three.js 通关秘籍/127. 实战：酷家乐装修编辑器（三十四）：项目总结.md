这节我们来总结一下我们做这个项目的过程。

首先，我们选择了 React + TypeScript 来写项目。

前端框架用 vue 或者 react 都行，是为了写网页交互的部分，大家可以换 vue，核心还是 3D 部分。

我们先写了布局：

![2025-05-19 11.38.41.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76f6e3bcf58a40418ce75ec550be3347~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2840&h=1528&s=258317&e=gif&f=35&b=fefefe)

然后需要用 json 存储数据，所以选择 react 生态的 zustand 来做全局状态管理。

这个 json 存储是必须的，比如酷家乐，它是怎么存储各种户型数据的？它是怎么把编辑好的装修效果保存到服务端的？明显也是用 json 存储。

我们在 json 里保存了 walls、floors、ceilings、furnitures 数据。

然后在 2D、3D、preview 这三个场景里把它同步画出来。

墙的存储格式我们试过了好几种，最终是记录 position、width、height、depth 是最简单的：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5bd0736bce744fb98b9a73fa1215a06a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=784&h=780&s=71828&e=png&b=1f1f1f)

用 Shape + ExtrudeGeometry 绘制墙，门窗就是上面的 holes，记录左下角的位置 leftBottomPosition 以及宽高就可以了。

天花板和地板是 Shape + ShapeGeometry 来绘制。

绘制好 3D 场景后，再绘制 2D 场景的时候我们遇到一个问题：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dec1786c752448a9a8b903843b8adada~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1474&h=1184&s=377093&e=png&b=add9e6)

这个是绘制 Shape 的时候方向反了导致的，有两种解决方式：

- 反过来换个顺序绘制墙的 Shape
- 不用反着画，直接旋转 180 度就好了

我们选择了旋转 180 度的方式，这导致了位置都要用负的，并且 y 轴旋转角度要旋转 180 度：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/be5c4d1dd98746f9ac7d238348f3e369~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1200&h=616&s=95969&e=png&b=1f1f1f)

这样确实不大好，最好还是用第一种方式，改一下绘制 Shape 的顺序就好了。

![2025-06-26 15.52.24.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7509196ebb9d4ecba48ddeb80d8d3405~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=14441352&e=gif&f=41&b=87cae7)

解决 2D 视图绘制的问题之后，我们给它加上了尺寸、门窗标注：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc8f948365bf4a3faae5fdba74f2a23f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1262&h=1124&s=319779&e=png&b=add9e6)

![2025-06-27 18.04.44.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/827c39417e2e4291893703581e8b11fe~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=14981874&e=gif&f=49&b=a3d0e0)

用 LineSegments 来绘制线段，指定几个点，LineSegments 会两两连接。

并且中间用 three-spritetext 来画文字。

我们给每面墙记录了法线方向：

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2613f06c7b84548958b7cab8e8ba92a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=690&h=766&s=69741&e=png&b=1f1f1f)

和相机方向做向量点积，实现了面向摄像机的墙隐藏：

![2025-06-25 10.10.05.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff72310dfbec4f69913a13b97dd6ff7d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=17379872&e=gif&f=19&b=82c8e6)

户型绘制好后，接下来是家具部分：

从 sketchfab.com 找的门窗、家具模型。

用 TransformControls 来做家具的编辑：

![2025-07-02 14.33.27.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc561b7e35e640cebd5fa842751b0cc9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=4586461&e=gif&f=37&b=e6f3fb)

![2025-07-02 17.29.44.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e0795e5de1e47929a394a3acf48e587~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=1222821&e=gif&f=50&b=f3f3f3)

只支持位移、旋转，两个视图会同步。

然后做了家具列表，通过家具列表可以拖拽家具到 3D 场景：

![2025-07-25 19.42.20.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/376965e3e0f84da4b77601a1949c446b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2568&h=1418&s=3770634&e=gif&f=37&b=f6f6f6)

原理和点击的处理差不多，拿到拖拽到的位置距离 canvas 左上角的 offset。

然后用 RayCaster 来计算和地板的相交位置，在那个位置添加家具。

这里拖拽的实现用了 react-dnd，给拖拽的目标（img 图片）添加 useDrag，拖拽到的目标（canvas）添加 useDrop

之后我们绘制了预览的场景，用 FlyControls 来控制自由浏览。

![2025-07-29 20.55.51.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa8e088bd892458aa25e9def0c8a2c3c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=20517806&e=gif&f=43&b=b0d4e4)

并且给用全景图加了窗外的风景。

最后实现了家具信息的表单编辑：

![2025-07-31 13.26.11.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f5293af5751e40768c0a2c925e32bcf9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=1564990&e=gif&f=49&b=f5f5f5)

做完后我们和酷家乐的编辑器对比了下，整体流程是一样的：

![2025-08-05 22.17.37.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e25e046b911a48248ca5d14c33e8d107~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=7446498&e=gif&f=48&b=f1f4f4)

总结下这个项目的技术点：

- 用 react、ts、three.js 来开发装修编辑器
- zustand 实现全局 store 存储，实现 3D 场景的数据化保存
- react-dnd 实现拖拽家具到画布，结合 three.js 的 RayCaster 实现拖拖拽家具到 3D 场景的任意位置
- Shape + ExtrudeGeometry + holes 绘制墙，Shape + ShapeGeometry 绘制地板天花板
- LineSegments + SpriteText 绘制尺寸标注
- 向量点积实现面对摄像头的那一面隐藏
- TransformControls 实现家具的位置、旋转角度编辑
- FlyControls 实现全景浏览的飞行视角

做的过程比较曲折，代码也比较多，但这是一个比较综合的实战，把前面学到的基础综合运用了一遍。

以后再做任何 3D 编辑器的项目，都大差不差的，大家应该都有思路了。

做完这个之后，大家可以说自己可以做各种 3D 编辑器项目了。
