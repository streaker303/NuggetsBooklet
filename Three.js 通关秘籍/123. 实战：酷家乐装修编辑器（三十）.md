上节实现了基本的全景浏览功能：

![2025-07-29 18.26.04.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7da87e2bbc6c4996a565f037a1a8fd10~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=19832881&e=gif&f=50&b=b3d8e5)

![2025-07-29 20.33.36.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e42b8014b4bb458fbf914ec3537e6204~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=8857943&e=gif&f=19&b=e3f3f5)

这节我们来优化一下。

首先，酷家乐这个预览，窗外是有风景的：


![2025-07-29 20.41.09.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a7b590513ac427da505579dc48b5a33~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=14614804&e=gif&f=31&b=888278)

其实就是一个全景图。

我们现在窗外是黑乎乎的一片。

找个全景图：

https://github.com/QuarkGluonPlasma/threejs-course-code/blob/b5488ee334c7c6689f7a42c2d23c0fbf1297ac73/hdr-background/public/pic.hdr

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f643af1b47fc4bf48917599146e26856~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2256&h=546&s=91783&e=png&b=ffffff)

下载下来放到 public 目录：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07f389c29a89445594cb49b46efd907a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=556&h=760&s=67018&e=png&b=191919)

代码里加载下：


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/755d6d416ae045478baf13956aed46a7~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1402&h=770&s=135483&e=png&b=1f1f1f)

```javascript
const rgbeloader = new RGBELoader();

rgbeloader.load('./pic.hdr', function ( texture ) {
    texture.mapping = THREE.EquirectangularReflectionMapping;
    scene.background = texture;
});
```

![2025-07-29 20.55.51.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa8e088bd892458aa25e9def0c8a2c3c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=20517806&e=gif&f=43&b=b0d4e4)

这样，窗外就有风景了。

现在转的有点慢：


![2025-07-30 10.21.37.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97f0718fcf3940c2ae9ebfd2c1c89f2b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=16509424&e=gif&f=25&b=e0e0e0)

调一下速度：


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7ee9b331a1f46d18e9d83608ed86b41~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1300&h=414&s=96699&e=png&b=1f1f1f)


![2025-07-30 10.22.56.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a0f7f58254b74c86a391fafa09616db4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=18139974&e=gif&f=28&b=e5e5e5)

这样角度转的就快了。

然后我们实现下家具的删除。

store 加一个方法：


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0629c505f32441f1b040d6012e9bef15~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1362&h=570&s=119277&e=png&b=1f1f1f)


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/480a56680a7c40939c859c3b630ac137~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1482&h=732&s=102472&e=png&b=1f1f1f)

```javascript
deleteFurniture(id: string): void;
```
```javascript
deleteFurniture(id) {
    set(state => {
        return {
            ...state,
            data: {
                ...state.data,
                furnitures: state.data.furnitures.filter(item => {
                    return item.id !== id
                })
            }
        }
    })
}
```
然后我们要知道当前选中的家具是哪个，所以还要加一个 curSelectedFurniture 的属性：


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8899bde3e8a4650ad2656754a38d6b8~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1232&h=904&s=173688&e=png&b=1f1f1f)

```javascript
curSelectedFurniture: Furniture | null
```
```javascript
setCurSelectedFurniture(furnitureId: string): void;
```

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e70272f91db479db55ab9215f3829aa~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1434&h=862&s=147010&e=png&b=1f1f1f)
```javascript
curSelectedFurniture: null,
setCurSelectedFurniture(furnitureId) {
    set(state => {
        const found = state.data.furnitures.filter((item)=> {
            return item.id === furnitureId;
        });

        return {
            ...state,
            curSelectedFurniture: found.length ? found[0] : null
        }
    })
}
```
传入家具 id，找到对应的家具，设置到 curSelectedFurniture

然后点击选中物体的时候，如果是家具，就调用这个方法：

我们把 furniture.id 设置到了 name：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a027e0834f3c46d5b7dcdcc5b23c7c3e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1158&h=626&s=97982&e=png&b=1f1f1f)

所以点击的时候就取 name 来设置：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f2b45010f0440adbd8126d7226f132d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1812&h=850&s=167504&e=png&b=1f1f1f)


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a44e21a3a1f4afcbdba49a2dc1c5b3b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1248&h=488&s=95438&e=png&b=1f1f1f)

```javascript
setCurSelectedFurniture: Action['setCurSelectedFurniture']
```
点击的时候调用下：


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/346c8074bf7b4bed85b2fb462425f1a8~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1168&h=644&s=108756&e=png&b=1f1f1f)

```javascript
setCurSelectedFurniture(obj.target.name);
```
```javascript
setCurSelectedFurniture('');
```
我们在 Properties 组件里把它可视化展示一下：


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/557f7e435496447c8f3591b1cf473e61~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1268&h=770&s=155854&e=png&b=1f1f1f)

```javascript
JSON.stringify(curSelectedFurniture, null, 4)
```
试下效果：


![2025-07-30 15.38.03.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5869d2d9e5f94b778c7ab2b2caa7f266~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=1046199&e=gif&f=27&b=f4f4f4)

可以看到，点击不同家具，确实选中的家具信息变了。

同样的方式来加一下 2D 场景的选中逻辑：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9851a89154e43b29b1703c5c480c3a9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1854&h=480&s=99681&e=png&b=1f1f1f)


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/457fdf9e62474870a3d0647fb4d7c07c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1308&h=468&s=91926&e=png&b=1f1f1f)

```javascript
setCurSelectedFurniture: Action['setCurSelectedFurniture']
```


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42b4e47674bd434b8badcee62382f320~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1136&h=616&s=101591&e=png&b=1f1f1f)

```javascript
setCurSelectedFurniture(obj.target.name);
```
```javascript
setCurSelectedFurniture('');
```
试一下：


![2025-07-30 15.42.30.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03cf7306048d443cbf441178ab1c5560~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=807977&e=gif&f=25&b=add5e3)

也没问题。

接下来实现下删除：



![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2f1617bcee54016a67e753a797bafca~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1642&h=1112&s=237993&e=png&b=1f1f1f)

```javascript
useEffect(() => {
    const scene = scene3DRef.current!;
    function handleKeydown(e: KeyboardEvent) {
        if(e.key === 'Backspace') {
            if(curSelectedFurniture) {
                const furniture = scene.getObjectByName(curSelectedFurniture.id);

                if(furniture) {
                    furniture.parent?.remove(furniture);
                    deleteFurniture(furniture.name);
                    setCurSelectedFurniture('');
                }
            }
        }
    }
    window.addEventListener('keydown', handleKeydown);
    return () => {
        window.removeEventListener('keydown', handleKeydown);
    }
}, [curSelectedFurniture]);
```

监听键盘事件，当按下删除键的时候，找到 curSelectedFurniture 对应的对象删除，并且在 store 里删除。

试一下：


![2025-07-30 19.40.58.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb491b253d4141b59858e18e206da93a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=877195&e=gif&f=17&b=f4f4f4)

可以看到，家具确实删除了。

但是 TransformControls 没有 detach。

我们导出一个 detach 方法：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c98291d35f044c3cae4104d4ed36be17~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1014&h=816&s=109458&e=png&b=1f1f1f)

```javascript
function detachTransformControls() {
    transformControls.detach();
}
```
然后组件里接收下：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ab3940e4bb9401bbd7b1eb9c9fe8f3d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1400&h=528&s=180284&e=png&b=1f1f1f)


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5cc7393b82bf4989aa35c4978c6f2405~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1454&h=970&s=197419&e=png&b=1f1f1f)

```javascript
const detachTransformControls3DRef = useRef<() => void>(null);
```
```javascript
detachTransformControls3DRef.current = detachTransformControls;
```

删除的时候调用下：


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79f2f44274a04a829b64cbf7978d7055~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1352&h=842&s=145940&e=png&b=1f1f1f)

```javascript
detachTransformControls3DRef.current?.();
```
再试试：


![2025-07-30 20.29.38.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1234b70f7d9445abb0de6b6e1f1e21b8~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2820&h=1540&s=873809&e=gif&f=30&b=f4f4f4)

现在删除之后就 detach 了。

>案例代码上传了[小册仓库](https://github.com/QuarkGluonPlasma/threejs-course-code/tree/main/home-decoration-editor)

## 总结

这节我们给预览的场景里加上了全景图，窗外就有风景了。

然后实现了选中后按 delete 键删除家具。

现在删除家具还有一些问题，下节我们继续完善。
