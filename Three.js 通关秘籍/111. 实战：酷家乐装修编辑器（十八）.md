上节做了家具导入：

![2025-06-28 22.11.24.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85d932e2bb154af6b73e138f9efe8c67~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=12180491&e=gif&f=30&b=f4f3f3)

这节我们来做编辑。

其实和之前的 Three.js Editor 一样：

![2025-05-17 23.48.34.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6453ff02af84e7187a4318a52775063~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2690&h=1388&s=1284390&e=gif&f=60&b=030303)

只不过不支持放缩，家具大小是固定的。

酷家乐的家具编辑也是这样：


![2025-06-29 11.21.20.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0b817fb28794f45bb7a138471388252~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=6765423&e=gif&f=37&b=edf1f1)

只不过它是用自己写的控件，我们直接用 TransformControls 也是一样。


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f550b18515e42e19b9e49c3d6ffbe4c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1544&h=1046&s=219255&e=png&b=1f1f1f)

引入 TransformControls，把它 的 helper 添加到场景中。

然后 TransformControls 拖动的时候，禁用 OrbitControls，不然两者操作冲突。

```javascript
const transformControls = new TransformControls(camera, renderer.domElement);
const transformHelper = transformControls.getHelper();
scene.add(transformHelper);

transformControls.addEventListener('dragging-changed', function (event) {
    controls.enabled = !event.value;
});
```
然后点击的时候，把 TransformControls 给 attach 到目标对象上。

我们给所有的家具单独一个 group：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c444e80714614a42aedaac34d2ec42a7~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1276&h=1052&s=213850&e=png&b=1f1f1f)

```javascript
const furnitures = new THREE.Group();
furnitures.name = 'furnitures';
data.furnitures.forEach(furniture => {
    const gltfLoader = new GLTFLoader();
    gltfLoader.load(furniture.modelUrl, (gltf) => {
        furnitures.add(gltf.scene);
        gltf.scene.position.set(
            furniture.position.x,
            furniture.position.y,
            furniture.position.z
        );
        gltf.scene.rotation.x = furniture.rotation.x;
        gltf.scene.rotation.y = furniture.rotation.y;
        gltf.scene.rotation.z = furniture.rotation.z;
    });
})
house.add(furnitures);
```
这样点击的时候方便查找。

然后给模型的所有子对象标记 target，点击的时候可以找到正确的对象：

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c50ef3d97c654b67bbce338f2a175b0d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1294&h=1134&s=230679&e=png&b=1f1f1f)

```javascript
gltf.scene.traverse(obj => {
    (obj as any).target = gltf.scene;
})
```
然后来处理下点击：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7053cae0ce784d68aa136f54cac81e95~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1488&h=1108&s=261972&e=png&b=1f1f1f)

```javascript
const furnitures = scene.getObjectByName('furnitures')!;
const intersections2 = rayCaster.intersectObjects(furnitures.children);

if(intersections2.length) {
    const obj = intersections2[0].object as any;
    if(obj.target) {
        transformControls.attach(obj.target);
    }
} else {
    transformControls.detach();
}
```
找到所有家具，点击的时候和这些对象做检测。

如果点中了家具对象，就把 TransformControls 给 attach 上，否则 detach

试下效果：


![2025-06-29 13.12.48.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60c7831bb1214570b0181142df2e6930~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=2547990&e=gif&f=49&b=f3f3f3)

除了位移，还要做旋转：

![2025-06-29 13.43.29.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8338da37a9974537a845e35c770cbb64~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=5215109&e=gif&f=34&b=f1f3f4)

酷家乐的这个控件是自己写的，可以一起做平移、旋转。

而我们用 TransformControls 需要切换 mode：


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a72ccd1078be44518833a4b18548dadf~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1186&h=562&s=141966&e=png&b=1f1f1f)

```javascript
transformControls.mode = 'rotate';
transformControls.showX = false;
transformControls.showZ = false;
```
切换到 rotate 的 mode，然后禁用 X、Z 方向的旋转。

看下效果：


![2025-06-29 13.46.30.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ff9d83e3cad4c8b88d63a45dc252d42~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=1032795&e=gif&f=29&b=f5f5f5)

这样就只能做围绕 y 轴的旋转了。

我们导出个 changeMode 方法：



![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5601226954f40b3bbb00d6649215d25~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1158&h=1000&s=174749&e=png&b=1f1f1f)

```javascript
function changeMode(isTranslate: boolean) {
    if(isTranslate) {
        transformControls.mode = 'translate';
        transformControls.showX = true;
        transformControls.showZ = true;
    } else {
        transformControls.mode = 'rotate';
        transformControls.showX = false;
        transformControls.showZ = false;
    }
}
```
组件里接收下：


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e7aee9db4804bef9369b333f964c7c4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1526&h=1048&s=249747&e=png&b=1f1f1f)

```javascript
const changeModeRef = useRef<(isTranslate: boolean) => void>(null);
```
```javascript
changeModeRef.current = changeMode;
```
把切换按钮先放在之前 2D、3D 的按钮旁边：


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec992d7101b24ca49f403ebb222d87f1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1346&h=1068&s=226769&e=png&b=1f1f1f)

```javascript
<Button
    onClick={() => changeModeRef.current?.(true)}
    >平移</Button>
<Button
    onClick={() => changeModeRef.current?.(false)}
    >旋转</Button>
```

![2025-06-29 14.00.21.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84ec630392134d519bdefcbe85daad79~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2362&h=1398&s=2340138&e=gif&f=50&b=f4f4f4)

这样，家具的平移、旋转就完成了。

>案例代码上传了[小册仓库](https://github.com/QuarkGluonPlasma/threejs-course-code/tree/main/home-decoration-editor)

## 总结

这节我们实现了家具的平移、旋转操作。

用 TransformControls 来做平移、旋转，点击家具的时候，把它 attach 到目标家具，没点中家具就 detach。

这里为了方便查找，我们把所有家具单独放在一个 group里，并给这个 group 一个 name。点击的时候，射线和这个 group 里的家具做相交判断。

并且我们加了两个按钮来切换 translate、rotate 两种操作模式。

平移、旋转实现了，下节我们继续完善编辑功能。


